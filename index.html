<!doctype html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grand Budapest Hotel - Final</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

  <script>
    AFRAME.registerComponent('time-travel', {
      schema: { startModern: { type: 'boolean', default: true } },

      // Helpers réutilisables
      $: (id) => document.querySelector(id),
      setSrc: function(id, src) { const el = this.$(id); if (el) el.setAttribute('src', src); },
      setColor: function(id, color) { const el = this.$(id); if (el) el.setAttribute('color', color); },
      setVis: function(id, vis) { const el = this.$(id); if (el) el.setAttribute('visible', vis); },

      init: function () {
        this.isModern = this.data.startModern;
        this.isTransitioning = false;
        this.audioBell = this.$('#audio-bell-ring');
        this.audioModern = this.$('#audio-music-modern');
        this.audioOld = this.$('#audio-music-old');
        
        // Initialiser les volumes
        if (this.audioModern) this.audioModern.volume = this.isModern ? 1 : 0;
        if (this.audioOld) this.audioOld.volume = this.isModern ? 0 : 1;

        if (this.el.sceneEl.hasLoaded) this.updateScene();
        else this.el.sceneEl.addEventListener('loaded', () => this.updateScene());

        this.el.addEventListener('click', () => {
          if (!this.isTransitioning) this.startTimeTravel();
        });
      },

      // Fondu audio progressif
      fadeAudio: function(audioOut, audioIn, duration = 3000) {
        const steps = 30;
        const interval = duration / steps;
        let step = 0;
        
        // Démarrer la nouvelle musique à volume 0
        if (audioIn) {
          audioIn.volume = 0;
          audioIn.play().catch(() => {});
        }
        
        const fade = setInterval(() => {
          step++;
          const progress = step / steps;
          
          if (audioOut) audioOut.volume = Math.max(0, 1 - progress);
          if (audioIn) audioIn.volume = Math.min(1, progress);
          
          if (step >= steps) {
            clearInterval(fade);
            if (audioOut) {
              audioOut.pause();
              audioOut.volume = 1; // Reset pour la prochaine fois
            }
          }
        }, interval);
      },

      startTimeTravel: function () {
        this.isTransitioning = true;
        const toModern = !this.isModern;

        if (this.audioBell) {
          this.audioBell.currentTime = 0;
          this.audioBell.play().catch(() => {});
        }
        
        // Fondu musical immédiat au click
        if (toModern) {
          this.fadeAudio(this.audioOld, this.audioModern, 3000);
        } else {
          this.fadeAudio(this.audioModern, this.audioOld, 3000);
        }

        this.transitionElements(toModern);
        setTimeout(() => { this.isTransitioning = false; }, 6000);
      },

      // Animation depop/pop pour objets légers uniquement
      depop: function(id, callback) {
        const el = this.$(id);
        if (!el) return callback?.();
        const dur = 350 + Math.random() * 200;
        el.setAttribute('animation__depop', { property: 'scale', to: '0 0 0', dur, easing: 'easeInBack' });
        setTimeout(() => {
          el.setAttribute('visible', false);
          el.removeAttribute('animation__depop');
          el.setAttribute('scale', '1 1 1');
          callback?.();
        }, dur);
      },

      pop: function(id, scale = '1 1 1') {
        const el = this.$(id);
        if (!el) return;
        const dur = 400 + Math.random() * 250;
        el.setAttribute('scale', '0 0 0');
        el.setAttribute('visible', true);
        el.setAttribute('animation__pop', { property: 'scale', to: scale, dur, easing: 'easeOutElastic' });
        setTimeout(() => el.removeAttribute('animation__pop'), dur);
      },

      swap: function(hideId, showId, showScale = '1 1 1') {
        this.depop(hideId, () => this.pop(showId, showScale));
      },

      transitionElements: function (toModern) {
        const m = toModern;

        // === 0ms - Mur du fond + Bureau et accessoires ===
        setTimeout(() => {
          this.setColor('#mur-fond', m ? '#B1B0AE' : '#EB97AC');
          
          if (m) {
            this.swap('#le-bureau-old', '#le-bureau-modern', '0.04 0.04 0.05');
            this.depop('#groupe-elements-anciens', () => this.pop('#groupe-elements-modernes'));
          } else {
            this.swap('#le-bureau-modern', '#le-bureau-old', '1 1.2 0.8');
            this.depop('#groupe-elements-modernes', () => this.pop('#groupe-elements-anciens'));
          }
        }, 0);

        // === 800ms - Horloge + Sol ===
        setTimeout(() => {
          this.setSrc('#sol-principal', m ? '#tex-sol-modern' : '#tex-sol-old');
          if (m) this.swap('#horloge-old', '#horloge-moderne');
          else this.swap('#horloge-moderne', '#horloge-old');
        }, 800);

        // === 1500ms - Mur droit + Escaliers droits + Lumières avant ===
        setTimeout(() => {
          this.setColor('#mur-droit', m ? '#B1B0AE' : '#EB97AC');
          this.setColor('#mur-stairs-d-1', m ? '#B1B0AE' : '#EB97AC');
          this.setColor('#mur-stairs-d-2', m ? '#B1B0AE' : '#EB97AC');
          
          this.setVis('#escalier-droit-bas', m);
          this.setVis('#escalier-droit-haut', m);
          this.setVis('#escalier-old-droit-bas', !m);
          this.setVis('#escalier-old-droit-haut', !m);
          
          if (m) {
            this.swap('#light-old', '#light-modern', '0.5 0.5 0.5');
            this.swap('#light-old-2', '#light-modern-2', '0.5 0.5 0.5');
          } else {
            this.swap('#light-modern', '#light-old', '2 2 2');
            this.swap('#light-modern-2', '#light-old-2', '2 2 2');
          }
        }, 1500);

        // === 2300ms - Plafond + Ascenseurs + Tapis ===
        setTimeout(() => {
          this.setSrc('#plafond', m ? '#tex-plafond-modern' : '#tex-plafond-old');
          document.querySelectorAll('.elevator-changeable').forEach(el => el.setAttribute('src', m ? '#tex-elevator-modern' : '#tex-elevator-old'));
          document.querySelectorAll('.carpet-changeable').forEach(el => el.setAttribute('src', m ? '#tex-carpet-modern' : '#tex-carpet-old'));
        }, 2300);

        // === 3000ms - Décor extérieur + Entrée + Lumières arrière ===
        setTimeout(() => {
          this.setSrc('#decor-exterieur', m ? '#tex-mount-modern' : '#tex-mount-old');
          this.setVis('#entrance-modern', m);
          this.setVis('#entrance-old', !m);
          
          if (m) {
            this.swap('#light-old-3', '#light-modern-3', '0.5 0.5 0.5');
            this.swap('#light-old-4', '#light-modern-4', '0.5 0.5 0.5');
          } else {
            this.swap('#light-modern-3', '#light-old-3', '2 2 2');
            this.swap('#light-modern-4', '#light-old-4', '2 2 2');
          }
        }, 3000);

        // === 3800ms - Mur gauche + Escaliers gauches ===
        setTimeout(() => {
          this.setColor('#mur-gauche', m ? '#B1B0AE' : '#EB97AC');
          this.setColor('#mur-stairs-g-1', m ? '#B1B0AE' : '#EB97AC');
          this.setColor('#mur-stairs-g-2', m ? '#B1B0AE' : '#EB97AC');
          
          this.setVis('#escalier-gauche-bas', m);
          this.setVis('#escalier-gauche-haut', m);
          this.setVis('#escalier-old-gauche-bas', !m);
          this.setVis('#escalier-old-gauche-haut', !m);
        }, 3800);

        // === 4500ms - Lumière centrale + Fin ===
        setTimeout(() => {
          if (m) this.swap('#light-old-5', '#light-modern-5', '1 1 1');
          else this.swap('#light-modern-5', '#light-old-5', '2 2 2');

          this.isModern = m;
        }, 4500);
      },

      updateScene: function () {
        const m = this.isModern;

        // Textures
        this.setSrc('#sol-principal', m ? '#tex-sol-modern' : '#tex-sol-old');
        this.setSrc('#plafond', m ? '#tex-plafond-modern' : '#tex-plafond-old');
        this.setSrc('#decor-exterieur', m ? '#tex-mount-modern' : '#tex-mount-old');

        // Couleurs murs
        ['#mur-fond', '#mur-gauche', '#mur-droit', '#mur-stairs-d-1', '#mur-stairs-d-2', '#mur-stairs-g-1', '#mur-stairs-g-2']
          .forEach(id => this.setColor(id, m ? '#B1B0AE' : '#EB97AC'));

        // Visibilité objets
        this.setVis('#le-bureau-modern', m);
        this.setVis('#le-bureau-old', !m);
        this.setVis('#groupe-elements-modernes', m);
        this.setVis('#groupe-elements-anciens', !m);
        this.setVis('#entrance-modern', m);
        this.setVis('#entrance-old', !m);
        this.setVis('#horloge-moderne', m);
        this.setVis('#horloge-old', !m);

        // Escaliers
        ['#escalier-droit-bas', '#escalier-droit-haut', '#escalier-gauche-bas', '#escalier-gauche-haut'].forEach(id => this.setVis(id, m));
        ['#escalier-old-droit-bas', '#escalier-old-droit-haut', '#escalier-old-gauche-bas', '#escalier-old-gauche-haut'].forEach(id => this.setVis(id, !m));

        // Lumières
        ['#light-modern', '#light-modern-2', '#light-modern-3', '#light-modern-4', '#light-modern-5'].forEach(id => this.setVis(id, m));
        ['#light-old', '#light-old-2', '#light-old-3', '#light-old-4', '#light-old-5'].forEach(id => this.setVis(id, !m));

        // Textures ascenseurs/tapis
        document.querySelectorAll('.elevator-changeable').forEach(el => el.setAttribute('src', m ? '#tex-elevator-modern' : '#tex-elevator-old'));
        document.querySelectorAll('.carpet-changeable').forEach(el => el.setAttribute('src', m ? '#tex-carpet-modern' : '#tex-carpet-old'));

        // Musique (volume direct sans fondu au chargement)
        if (m) {
          if (this.audioOld) { this.audioOld.pause(); this.audioOld.volume = 0; }
          if (this.audioModern) { this.audioModern.volume = 1; this.audioModern.play().catch(() => {}); }
        } else {
          if (this.audioModern) { this.audioModern.pause(); this.audioModern.volume = 0; }
          if (this.audioOld) { this.audioOld.volume = 1; this.audioOld.play().catch(() => {}); }
        }
      }
    });
  </script>
</head>

<body>
  <a-scene background="color: #F0F0F0">

    <a-assets timeout="10000">
      <audio id="audio-music-modern" src="assets/MusicModern.mp3" preload="auto" loop="true"></audio>
      <audio id="audio-music-old" src="assets/MusicOld.mp3" preload="auto" loop="true"></audio>
      <audio id="audio-bell-ring" src="assets/BellRing.wav" preload="auto"></audio>

      <a-asset-item id="asset-desk-modern" src="assets/DeskModern.glb"></a-asset-item>
      <a-asset-item id="asset-desk-old" src="assets/DeskOld.glb"></a-asset-item>
      <a-asset-item id="asset-bell" src="assets/DeskBell.glb"></a-asset-item>
      <a-asset-item id="asset-periph" src="assets/SourisClavier.glb"></a-asset-item>
      <a-asset-item id="asset-imac" src="assets/iMac.glb"></a-asset-item>
      <a-asset-item id="asset-book" src="assets/Book.glb"></a-asset-item>
      <a-asset-item id="asset-pen" src="assets/Pen.glb"></a-asset-item>
      <a-asset-item id="asset-stairs-modern" src="assets/StairsModern.glb"></a-asset-item>
      <a-asset-item id="asset-stairs-old" src="assets/StairsOld.glb"></a-asset-item>
      <a-asset-item id="asset-entrance-modern" src="assets/EntranceModern.glb"></a-asset-item>
      <a-asset-item id="asset-entrance-old" src="assets/EntranceOld.glb"></a-asset-item>
      <a-asset-item id="asset-light-modern" src="assets/LightModern.glb"></a-asset-item>
      <a-asset-item id="asset-light-old" src="assets/LightOld.glb"></a-asset-item>


      <img id="tex-elevator-modern" src="assets/ElevatorModern.png">
      <img id="tex-elevator-old" src="assets/ElevatorOld.png">
      <img id="tex-mount-modern" src="assets/MountModern.png">
      <img id="tex-mount-old" src="assets/MountOld.png">
      <img id="tex-sol-modern" src="assets/SolModern.jpg">
      <img id="tex-sol-old" src="assets/SolOld.jpg">
      <img id="tex-plafond-modern" src="assets/PlafondModern.jpg">
      <img id="tex-plafond-old" src="assets/PlafondOld.jpg">

      <img id="tex-carpet-modern" src="assets/CarpetModern.png">
      <img id="tex-carpet-old" src="assets/CarpetOld.png">
      <img id="tex-clock-modern" src="assets/ClockModern.png">
      <img id="tex-clock-old" src="assets/ClockOld.png">
    </a-assets>

    <a-entity light="type: ambient; color: #FFF; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; color: #FFF; intensity: 0.5" position="-2 4 2"></a-entity>

    <a-entity id="light-modern" gltf-model="#asset-light-modern" position="-4.19 5.942 -5" scale="0.5 0.5 0.5">
      <a-light type="point" intensity="0.6" distance="10" decay="2" color="#FFDDAA"></a-light>
    </a-entity>
    <a-entity id="light-modern-2" gltf-model="#asset-light-modern" position="3.909 5.942 -5" scale="0.5 0.5 0.5">
      <a-light type="point" intensity="0.6" distance="10" decay="2" color="#FFDDAA"></a-light>
    </a-entity>
    <a-entity id="light-modern-3" gltf-model="#asset-light-modern" position="-4.19 5.942 7" scale="0.5 0.5 0.5">
      <a-light type="point" intensity="0.4" distance="8" decay="2" color="#FFDDAA"></a-light>
    </a-entity>
    <a-entity id="light-modern-4" gltf-model="#asset-light-modern" position="3.909 5.942 7" scale="0.5 0.5 0.5">
      <a-light type="point" intensity="0.4" distance="8" decay="2" color="#FFDDAA"></a-light>
    </a-entity>
    <a-entity id="light-modern-5" gltf-model="#asset-light-modern" position="-0.122 5.942 1" scale="1 1 1">
      <a-light type="point" intensity="0.7" distance="12" decay="2" color="#FFDDAA"></a-light>
    </a-entity>

    <!-- Lumières anciennes (style vintage) -->
    <a-entity id="light-old" gltf-model="#asset-light-old" position="-4.19 4.05 -5" scale="2 2 2" visible="false">
      <a-light type="point" intensity="2" distance="5" decay="2" color="#FFD700"></a-light>
    </a-entity>
    <a-entity id="light-old-2" gltf-model="#asset-light-old" position="3.909 4.05 -5" scale="2 2 2" visible="false">
      <a-light type="point" intensity="2" distance="5" decay="2" color="#FFD700"></a-light>
    </a-entity>
    <a-entity id="light-old-3" gltf-model="#asset-light-old" position="-4.19 4.05 7" scale="2 2 2" visible="false">
      <a-light type="point" intensity="1.8" distance="4" decay="2" color="#FFD700"></a-light>
    </a-entity>
    <a-entity id="light-old-4" gltf-model="#asset-light-old" position="3.909 4.05 7" scale="2 2 2" visible="false">
      <a-light type="point" intensity="1.8" distance="4" decay="2" color="#FFD700"></a-light>
    </a-entity>
    <a-entity id="light-old-5" gltf-model="#asset-light-old" position="-0.122 4.05 1" scale="2 2 2" visible="false">
      <a-light type="point" intensity="2.5" distance="6" decay="2" color="#FFD700"></a-light>
    </a-entity>


    <a-plane id="sol-principal" src="#tex-sol-modern" repeat="8 8" position="0 0 1.1" rotation="-90 0 0" width="21"
      height="21.800" roughness="0.5" metalness="0.1"></a-plane>
    <a-plane id="plafond" src="#tex-plafond-modern" repeat="8 8" position="0 6 1.278" rotation="90 0 0" width="21"
      height="21.800"></a-plane>

    <a-box id="mur-fond" color="#B1B0AE" position="0 4 -9.70" width="20" height="8" depth="0.5"></a-box>
    <a-box id="mur-gauche" color="#B1B0AE" position="-10 4 0" rotation="0 90 0" width="20" height="8"
      depth="0.5"></a-box>
    <a-box id="mur-droit" color="#B1B0AE" position="10 4 0" rotation="0 90 0" width="20" height="8" depth="0.5"></a-box>

    <a-entity id="escalier-droit-bas" gltf-model="#asset-stairs-modern" position="6.302 -0.08 -0.32"
      scale="0.32 0.25 0.25" rotation="1.03 -90 0.61"></a-entity>
    <a-entity id="escalier-droit-haut" gltf-model="#asset-stairs-modern" position="6.302 -0.10 -1.97"
      scale="-0.32 0.25 0.25" rotation="1.03 -90 0.61"></a-entity>
    <a-box id="mur-stairs-d-1" color="#B1B0AE" position="7.49 4 6.19" rotation="0 90 0" width="11.61" height="8"
      depth="3"></a-box>
    <a-box id="mur-stairs-d-2" color="#B1B0AE" position="7.99 4 -6.73" rotation="0 90 0" width="8" height="8"
      depth="4"></a-box>

    <a-entity id="escalier-gauche-bas" gltf-model="#asset-stairs-modern" position="-6.302 -0.10 -0.37"
      scale="-0.32 0.25 0.25" rotation="1.03 90 0.61"></a-entity>
    <a-entity id="escalier-gauche-haut" gltf-model="#asset-stairs-modern" position="-6.302 -0.08 -2.00"
      scale="0.32 0.25 0.25" rotation="1.03 90 0.61"></a-entity>
    <a-box id="mur-stairs-g-1" color="#B1B0AE" position="-7.49 4 6.19" rotation="0 90 0" width="11.61" height="8"
      depth="3"></a-box>
    <a-box id="mur-stairs-g-2" color="#B1B0AE" position="-7.99 4 -6.73" rotation="0 90 0" width="8" height="8"
      depth="4"></a-box>

    <!-- Escaliers anciens -->
    <a-entity id="escalier-old-droit-bas" gltf-model="#asset-stairs-old" position="6.311 -0.08 -0.50372"
      scale="0.32 0.25 0.25" rotation="1.03 -90 0.61" visible="false"></a-entity>
    <a-entity id="escalier-old-droit-haut" gltf-model="#asset-stairs-old" position="6.302 -0.1 -1.83147"
      scale="-0.32 0.25 0.25" rotation="1.03 -90 0.61" visible="false"></a-entity>
    <a-entity id="escalier-old-gauche-bas" gltf-model="#asset-stairs-old" position="-6.302 -0.1 -0.51058"
      scale="-0.32 0.25 0.25" rotation="1.03 90 0.61" visible="false"></a-entity>
    <a-entity id="escalier-old-gauche-haut" gltf-model="#asset-stairs-old" position="-6.302 -0.08 -1.86841"
      scale="0.32 0.25 0.25" rotation="1.03 90 0.61" visible="false"></a-entity>


    <a-image class="elevator-changeable" src="#tex-elevator-modern" position="5.989 1.782 4.345" rotation="0 -90 0"
      width="4" height="5" transparent="true" material="" geometry="width: 3; height: 4">
    </a-image>

    <a-image class="elevator-changeable" src="#tex-elevator-modern" position="-5.89 1.7815 4.34474" rotation="0 90 0"
      width="4" height="5" transparent="true" material="" geometry="width: 3; height: 4">
    </a-image>

    <a-image class="carpet-changeable" src="#tex-carpet-modern" position="0 0.02 2.88814" rotation="-90 90 0" width="6"
      height="4" transparent="true" material="" geometry="" scale="2 2 2">
    </a-image>

    <!-- Horloges -->
    <a-image id="horloge-moderne" src="#tex-clock-modern" position="0 3.858 -9.446" width="1.5" height="1.5"
      transparent="true" visible="" material="" geometry="">
    </a-image>
    <a-image id="horloge-old" src="#tex-clock-old" position="0 3.858 -9.446" width="1.5" height="1.5" transparent="true"
      visible="false" material="" geometry="">
    </a-image>

    <a-entity id="entrance-modern" gltf-model="#asset-entrance-modern" position="-6.4 0.3165 4.238" rotation="0 90 0"
      scale="1 1.4 1.06"></a-entity>
    <a-entity id="entrance-old" gltf-model="#asset-entrance-old" position="-6.4 0.3165 4.238" rotation="0 90 0"
      scale="1 1.4 1.06" visible="false"></a-entity>

    <a-plane id="decor-exterieur" src="#tex-mount-modern" position="0 -20 40" rotation="0 180 0" width="100" height="60"
      material="shader: flat; fog: false"></a-plane>
    <a-box position="0 4 5" width="30" height="10" depth="1" color="#333" side="back" visible="false"></a-box>

    <a-entity id="le-bureau-modern" gltf-model="#asset-desk-modern" position="-0.088 0.891 -7.163"
      scale="0.04 0.04 0.05" visible="true"></a-entity>
    <a-entity id="le-bureau-old" gltf-model="assets/DeskOld.glb" position="-0.088 -0.03737 -6.18852" scale="1 1.2 0.8"
      visible=""></a-entity>
    <a-entity id="la-sonnette" position="-0.122 1.109 -5.503" time-travel="startModern: true">

      <a-entity gltf-model="#asset-bell" scale="10 10 10"></a-entity>

      <a-sphere class="clickable" radius="0.15" material="opacity: 0; transparent: true" position="0 0.1 0"></a-sphere>

      <a-sphere position="0 0.3 0" radius="0.02" color="#FFFFFF" material="shader: flat; opacity: 0.8"
        animation="property: position; from: 0 0.3 0; to: 0 0.35 0; dir: alternate; loop: true; dur: 1000; easing: easeInOutSine"
        animation__scale="property: scale; from: 1 1 1; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 1000; easing: easeInOutSine">
      </a-sphere>

    </a-entity>

    <a-entity id="groupe-elements-modernes" visible="true">
      <a-entity id="periph-gauche" gltf-model="#asset-periph" position="-1.166 -1.692 -6.640" scale="3 3 3"
        rotation="0 180 0"></a-entity>
      <a-entity id="imac-gauche" gltf-model="#asset-imac" position="-1.541 1.12 -5.828" scale="0.3 0.3 0.3"
        rotation="0 -15.65 0"></a-entity>
      <a-entity id="periph-droit" gltf-model="#asset-periph" position="1.294 -1.692 -6.640" scale="3 3 3"
        rotation="0 180 0"></a-entity>
      <a-entity id="imac-droit" gltf-model="#asset-imac" position="1.319 1.12 -5.828" scale="0.3 0.3 0.3"
        rotation="0 12.88 0"></a-entity>
    </a-entity>

    <a-entity id="groupe-elements-anciens" visible="false">
      <a-entity id="book-gauche" gltf-model="assets/Book.glb" position="-1.16529 1.12451 -5.69059" scale="0.3 0.3 0.3"
        rotation="0 -99.05351658001184 0"></a-entity>
      <a-entity id="book-droit" gltf-model="assets/Book.glb" position="0.975 1.12451 -5.66952" scale="0.3 0.3 0.3"
        rotation="0 99.05351658001184 0"></a-entity>
      <a-entity id="pen-gauche" gltf-model="assets/Pen.glb" position="-0.66722 1.122 -5.56358" scale="1.5 1.5 1.5"
        rotation="0 100 0"></a-entity>
      <a-entity id="pen-droit" gltf-model="assets/Pen.glb" position="1.42946 1.122 -5.77499" scale="1.5 1.5 1.5"
        rotation="0 119.99999999999999 0"></a-entity>
    </a-entity>



    <a-entity id="camera-rig" position="0 0.5 -2.75">

      <a-entity camera look-controls wasd-controls>
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable; interval: 500">
        </a-entity>
      </a-entity>

      <a-entity laser-controls="hand: left" raycaster="objects: .clickable; far: 5; interval: 500"
        line="color: red; opacity: 0.75">
      </a-entity>

      <a-entity laser-controls="hand: right" raycaster="objects: .clickable; far: 5; interval: 500"
        line="color: red; opacity: 0.75">
      </a-entity>

    </a-entity>

  </a-scene>

  <script>
    document.addEventListener('click', function () {
      const audio = document.querySelector('#audio-music-modern');
    }, { once: true });
  </script>
</body>

</html>